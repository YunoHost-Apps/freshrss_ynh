#!/bin/bash

set -eu

app=$YNH_APP_INSTANCE_NAME
db_user=$app
db_name=$app


# Source app helpers
. /usr/share/yunohost/helpers

# retrieve useful param
domain=$(ynh_app_setting_get $app domain)
path=$(ynh_app_setting_get $app path)
dbpass=$(ynh_app_setting_get $app mysqlpwd)

# Check domain/path availability
sudo yunohost app checkurl $domain$path -a $app || ynh_die "The path ${domain}${path} is not available for app installation."

# Restore sources & data
final_path=/var/www/$app
sudo mkdir $final_path
ynh_backup "www" "$final_path"

# Restore permissions
sudo chown -R root:root $final_path
sudo chown -R www-data: $final_path/data/
sudo chown -R www-data: $final_path/extensions/

# Restore conf files
ynh_backup "www" "$final_path"
ynh_backup "nginx.conf" /etc/nginx/conf.d/$domain.d/$app.conf
ynh_backup "$app.cron" /etc/cron.d/$app

# Restore mysql dump
ynh_mysql_create_db "$dbname" "$dbuser" "$dbpass"
ynh_mysql_connect_as "$dbuser" "$dbpass" "$dbname" < "$app.dmp"

# Reload Nginx, and regenerate SSOwat conf
sudo service nginx reload
sudo yunohost app ssowatconf
